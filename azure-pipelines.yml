trigger:
  branches:
    include:
      - main

pool:
  name: SelfHosted   # <- Usar tu agente propio

stages:
- stage: CI
  displayName: CI Front & Back
  jobs:
  - job: Front
    displayName: Build Front (Vite)
    steps:
    - checkout: self

    - task: NodeTool@0
      displayName: Use Node 20.x
      inputs:
        versionSpec: '20.x'
        checkLatest: true

    - script: |
        node -v
        npm -v
      displayName: Check Node/NPM

    - task: PowerShell@2
      displayName: Install & Build (front)
      inputs:
        targetType: 'inline'
        workingDirectory: 'front'
        script: |
          Write-Host "== PWD =="; Get-Location
          if (!(Test-Path ".\index.html")) {
            throw "No se encontró front\index.html. Crealo o configurá Vite (rollup input/lib)."
          }

          Write-Host "== npm ci =="; npm ci
          Write-Host "== vite build =="; npx vite build --logLevel info

          if (!(Test-Path ".\dist")) {
            throw "dist NO existe tras el build."
          }
          Write-Host "== dist listo =="; Get-ChildItem -Path ".\dist" -Recurse

    - task: PublishBuildArtifacts@1
      displayName: Publicar artefacto front (dist)
      inputs:
        PathtoPublish: '$(Build.SourcesDirectory)\front\dist'
        ArtifactName: 'front-dist'
        publishLocation: 'Container'

  - job: Back
    displayName: Build Back (Node)
    steps:
    - script: node -v && npm -v
      displayName: Check Node/NPM
    - script: |
        cd back
        npm ci
        npm test
        npm run build
      displayName: test & build (back)
    - task: PublishBuildArtifacts@1
      displayName: Publicar artefacto back (bin)
      inputs:
        PathtoPublish: 'back/bin'
        ArtifactName: 'back-bin'
        publishLocation: 'Container'